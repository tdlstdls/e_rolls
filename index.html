<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>イベロ</title>
  <style>
    /* グローバル設定 */
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      line-height: 1.6;
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
      background-color: #f4f7f9;
      color: #333;
    }

    /* コンテナとセクション */
    .container {
      background: #fff;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
    }
    
    h1 {
      color: #004085;
      font-size: 2.2rem;
      border-bottom: 3px solid #e9ecef;
      padding-bottom: 10px;
      margin-top: 0;
      text-align: center;
    }

    /* フォームコントロール */
    .controls {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      gap: 20px;
      margin-bottom: 30px;
      padding: 15px;
      background-color: #f9fbfd;
      border-radius: 8px;
    }
    
    .input-item {
      flex: 1 1 250px;
      display: flex;
      flex-direction: column;
    }

    label {
      font-weight: 600;
      margin-bottom: 8px;
      color: #555;
    }
    
    input[type="number"],
    select {
      padding: 12px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 1rem;
      width: 100%;
      box-sizing: border-box;
      transition: border-color 0.3s;
    }
    
    input[type="number"]:focus,
    select:focus {
      outline: none;
      border-color: #007bff;
    }

    button {
      background-color: #007bff;
      color: #fff;
      border: none;
      padding: 12px 25px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1.1rem;
      font-weight: bold;
      transition: background-color 0.3s ease, transform 0.2s ease;
      width: 100%;
    }
    
    button:hover {
      background-color: #0056b3;
      transform: translateY(-2px);
    }

    /* 結果テーブル */
    #result-container {
      margin-top: 30px;
    }

    #result-table-container {
      overflow-x: auto;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
    }

    th, td {
      padding: 12px 8px;
      text-align: center;
      border: 1px solid #e0e0e0;
      word-break: break-word;
      font-size: 0.9rem;
    }
    
    th {
      background-color: #f0f4f7;
      color: #444;
      font-weight: 600;
      position: sticky;
      top: 0;
    }
    
    td {
      background-color: #fff;
    }

    .row-number-header {
      font-family: Arial, sans-serif;
      font-weight: bold;
      width: 60px;
    }

    /* セルのハイライトとテキストスタイル */
    .eyeball-text {
      color: #d9534f;
      font-weight: bold;
    }
    
    .re-gacha-cell {
      line-height: 1.4;
    }

    /* G列の着色 */
    .g-ten-pull-highlight {
      background-color: #fffacd;
    }

  </style>
</head>
<body>

  <div class="container">
    <h1>イベロ</h1>
    <div class="input-group">
      <div class="controls">
        <div class="input-item">
          <label for="gachaIdSelector">Gacha</label>
          <select id="gachaIdSelector">
            <option value="34">34: ハロウィン</option>
            <option value="42" selected>42: 1.1億DL記念</option>
          </select>
        </div>
        <div class="input-item">
          <label for="seedInput">SEED</label>
          <input type="number" id="seedInput" value="123456789">
        </div>
        <div class="input-item">
          <label for="guaranteedRollsInput">最初の確定枠までのロール数</label>
          <input type="number" id="guaranteedRollsInput" value="30" min="1">
        </div>
        <div class="input-item" style="display: flex; align-items: flex-end;">
          <button id="executeButton">更新</button>
        </div>
      </div>
    </div>
    
    <div id="result-container">
      <div id="result-table-container"></div>
    </div>
  </div>

  <script>
    function xorshift32(seed) {
      let x = seed;
      x ^= x << 13;
      x ^= x >>> 17;
      x ^= x << 15;
      return x >>> 0;
    }

    const gachaData = {
      '34': {
        name: 'ハロウィン',
        targetRate: 600,
        rarityRates: { '0': 2000, '1': 5000, '2': 3000, '3': 0, '4': 0 }
      },
      '42': {
        name: '1.1億DL記念',
        targetRate: 500,
        rarityRates: { '0': 1000, '1': 5000, '2': 3000, '3': 1000, '4': 0 }
      }
    };

    const gachaMaster = {
      '34': {
        '0': { itemCounts: 1, itemNo: [10] },
        '1': { itemCounts: 4, itemNo: [0, 3, 11, 12] },
        '2': { itemCounts: 4, itemNo: [2, 4, 5, 14] },
        '3': { itemCounts: 3, itemNo: [375, 381, 689] },
        '4': { itemCounts: 0, itemNo: [] }
      },
      '42': {
        '0': { itemCounts: 1, itemNo: [10] },
        '1': { itemCounts: 4, itemNo: [0, 3, 11, 12] },
        '2': { itemCounts: 4, itemNo: [2, 4, 5, 14] },
        '3': { itemCounts: 3, itemNo: [375, 381, 689] },
        '4': { itemCounts: 0, itemNo: [] }
      }
    };

    const itemNameMaster = {
      0: "スピダ",
      1: "トレレ",
      2: "ネコボン",
      3: "ニャンピュ",
      4: "おかめ",
      5: "スニャ",
      10: "5千XP",
      11: "1万XP",
      12: "3万XP",
      14: "10万XP",
      375: "記念ネコ",
      381: "ねこ農家",
      689: "石の上にも10年ネコ"
    };

    const itemNameToId = {
      "スピダ": 0,
      "トレレ": 1,
      "ネコボン": 2,
      "ニャンピュ": 3,
      "おかめ": 4,
      "スニャ": 5,
      "5千XP": 10,
      "1万XP": 11,
      "3万XP": 12,
      "10万XP": 14,
      "記念ネコ": 375,
      "ねこ農家": 381,
      "石の上にも10年ネコ": 689
    };
    
    const rarityNames = {
      '0': '通常',
      '1': 'レア',
      '2': '激レア',
      '3': '超激レア',
      '4': '伝説レア'
    };

    const seedInput = document.getElementById('seedInput');
    const gachaIdSelector = document.getElementById('gachaIdSelector');
    const guaranteedRollsInput = document.getElementById('guaranteedRollsInput');
    const executeButton = document.getElementById('executeButton');
    const resultTableContainer = document.getElementById('result-table-container');

    executeButton.addEventListener('click', () => {
        runSimulationAndDisplay();
    });

    function runSimulationAndDisplay() {
      const seedValue = parseInt(seedInput.value, 10);
      const firstGuaranteedRolls = parseInt(guaranteedRollsInput.value, 10) || 30;

      if (isNaN(seedValue)) {
        return;
      }

      let xorshiftArray = [];
      let moduloArray = [];
      let currentSeed = seedValue;
      for (let i = 0; i < 1000; i++) {
        currentSeed = xorshift32(currentSeed);
        xorshiftArray.push(currentSeed);
        moduloArray.push(currentSeed % 10000);
      }

      const selectedGachaId = gachaIdSelector.value;
      const gacha = gachaData[selectedGachaId];
      const master = gachaMaster[selectedGachaId];

      if (!gacha || !master) {
        return;
      }
      
      let items = new Array(300).fill(-1);
      let isEyeballCell = new Array(300).fill(false);
      let reGachaItems = new Array(300).fill("---");
      
      const rates = gacha.rarityRates;
      const thresholds = {
        '0': rates['0'],
        '1': rates['0'] + rates['1'],
        '2': rates['0'] + rates['1'] + rates['2'],
        '3': rates['0'] + rates['1'] + rates['2'] + rates['3'],
        '4': 10000
      };
      
      for (let i = 0; i < 300; i++) {
        const hitSeedIndex = i;
        const isHit = (moduloArray[hitSeedIndex] < gacha.targetRate);
        isEyeballCell[i] = isHit;

        if (isHit) {
            continue;
        }

        const raritySeedIndex = i + 1;
        const itemSeedIndex = i + 2;

        if (itemSeedIndex >= xorshiftArray.length) {
            continue;
        }

        let rarityId;
        if (moduloArray[raritySeedIndex] < thresholds['0']) { rarityId = 0; }
        else if (moduloArray[raritySeedIndex] < thresholds['1']) { rarityId = 1; }
        else if (moduloArray[raritySeedIndex] < thresholds['2']) { rarityId = 2; }
        else if (moduloArray[raritySeedIndex] < thresholds['3']) { rarityId = 3; }
        else { rarityId = 4; }

        const itemInfo = master[rarityId];
        if (itemInfo.itemCounts > 0) {
          const itemOffset = xorshiftArray[itemSeedIndex] % itemInfo.itemCounts;
          items[i] = itemInfo.itemNo[itemOffset];
        }

        if (rarityId === 1 && itemInfo.itemCounts >= 2) {
            const reGachaSeedIndex = itemSeedIndex + 1;
            if (reGachaSeedIndex < xorshiftArray.length) {
                const originalItemNoList = [...itemInfo.itemNo];
                const itemIndex = originalItemNoList.indexOf(items[i]);
                if (itemIndex > -1) {
                    originalItemNoList.splice(itemIndex, 1);
                }
                const newDivisor = originalItemNoList.length;
                const seedForReGacha = xorshiftArray[reGachaSeedIndex];
                const reGachaOffset = seedForReGacha % newDivisor;
                const reGachaItemId = originalItemNoList[reGachaOffset];
                
                let showReGacha = false;
                const prevItemIndex = i - 3;
                const prevPrevItemIndex = i - 2;

                if (items[i] !== -1) {
                    if (prevItemIndex >= 0 && items[i] === items[prevItemIndex]) {
                        showReGacha = true;
                    }
                    if (!showReGacha && prevItemIndex >= 0 && reGachaItems[prevItemIndex] !== "---" && items[i] === itemNameToId[reGachaItems[prevItemIndex]]) {
                        showReGacha = true;
                    }
                    if (!showReGacha && prevPrevItemIndex >= 0 && isEyeballCell[i-1]) {
                        if (reGachaItems[prevPrevItemIndex] !== "---" && items[i] === itemNameToId[reGachaItems[prevPrevItemIndex]]) {
                            showReGacha = true;
                        }
                    }
                }
                
                if (showReGacha) {
                    reGachaItems[i] = itemNameMaster[reGachaItemId];
                }
            }
        }
      }

      const tenPullResults = new Array(10).fill(null);
      const guaranteedRoll = (firstGuaranteedRolls > 0 && firstGuaranteedRolls <= 10) ? firstGuaranteedRolls - 1 : -1;
      let remainingIndices = Array.from({length: 10}, (_, i) => i);
      let currentSeedOffset = 0;
      let tenPullLastItemId = -1;
      
      if (guaranteedRoll !== -1) {
          tenPullResults[guaranteedRoll] = '目玉(確定)';
          const guaranteedIndex = remainingIndices.indexOf(guaranteedRoll);
          remainingIndices.splice(guaranteedIndex, 1);
      }
      
      const eyeballIndices = [];
      for (const index of remainingIndices) {
          const isHit = (moduloArray[currentSeedOffset] < gacha.targetRate);
          
          if (isHit) {
              tenPullResults[index] = '目玉';
              eyeballIndices.push(index);
          }
          currentSeedOffset++;
      }
      remainingIndices = remainingIndices.filter(index => !eyeballIndices.includes(index));

      for (const index of remainingIndices) {
          let raritySeedIndex = currentSeedOffset;
          let itemSeedIndex = currentSeedOffset + 1;
          
          let rarityId;
          if (moduloArray[raritySeedIndex] < thresholds['0']) { rarityId = 0; }
          else if (moduloArray[raritySeedIndex] < thresholds['1']) { rarityId = 1; }
          else if (moduloArray[raritySeedIndex] < thresholds['2']) { rarityId = 2; }
          else if (moduloArray[raritySeedIndex] < thresholds['3']) { rarityId = 3; }
          else { rarityId = 4; }
          
          const itemInfo = master[rarityId];
          let currentItemId = -1;
          let itemName = "---";
          
          if (itemInfo.itemCounts > 0) {
              const itemOffset = xorshiftArray[itemSeedIndex] % itemInfo.itemCounts;
              currentItemId = itemInfo.itemNo[itemOffset];
              itemName = itemNameMaster[currentItemId] || "不明";
          }
          
          let displayItemName = itemName;
          
          if (rarityId === 1 && tenPullLastItemId !== -1 && tenPullLastItemId === currentItemId) {
              const reGachaSeedIndex = itemSeedIndex + 1;
              if (reGachaSeedIndex < xorshiftArray.length) {
                  const originalItemNoList = [...itemInfo.itemNo];
                  const itemIndex = originalItemNoList.indexOf(currentItemId);
                  if (itemIndex > -1) {
                      originalItemNoList.splice(itemIndex, 1);
                  }
                  const newDivisor = originalItemNoList.length;
                  const seedForReGacha = xorshiftArray[reGachaSeedIndex];
                  const reGachaOffset = seedForReGacha % newDivisor;
                  const reGachaItemId = originalItemNoList[reGachaOffset];
                  
                  const nextRollRow = Math.floor((currentSeedOffset + 4) / 3) + 1;
                  const nextRollCol = String.fromCharCode('A'.charCodeAt(0) + ((currentSeedOffset + 4) % 3));
                  const nextRollAddress = `${nextRollCol}${nextRollRow}`;

                  displayItemName = `${itemName}▼<br>${nextRollAddress})${itemNameMaster[reGachaItemId]}`;
                  tenPullLastItemId = reGachaItemId;
                  currentSeedOffset += 3;
              } else {
                  tenPullLastItemId = currentItemId;
                  currentSeedOffset += 2;
              }
          } else {
              tenPullLastItemId = currentItemId;
              currentSeedOffset += 2;
          }
          
          tenPullResults[index] = displayItemName;
      }

      const nextRollIndex = currentSeedOffset;
      const nextRollRow = Math.floor(nextRollIndex / 3) + 1;
      const nextRollCol = String.fromCharCode('A'.charCodeAt(0) + (nextRollIndex % 3));
      const nextRollAddress = `${nextRollCol}${nextRollRow}`;

      const originalG9Content = tenPullResults[9];
      let newG9Display;
      
      if (originalG9Content && originalG9Content.includes('目玉')) {
        newG9Display = `<span class="eyeball-text">${originalG9Content}</span>`;
      } else {
        newG9Display = originalG9Content;
      }
      
      tenPullResults[9] = `${nextRollAddress}) ${newG9Display}`;


      createAndDisplayTable(items, isEyeballCell, guaranteedRollsInput.value, tenPullResults, reGachaItems);
    }
    
    function createAndDisplayTable(items, isEyeballCell, firstGuaranteedRolls, tenPullRows, reGachaItems) {
        let table = '<table><thead><tr><th class="row-number-header">❐</th><th>A</th><th>B</th><th>C</th><th>G</th></tr></thead><tbody>';
        
        for (let r = 0; r < 100; r++) {
            table += `<tr><td>${r + 1}</td>`;
            for (let c = 0; c < 3; c++) {
                const index = r * 3 + c;
                let classList = ['re-gacha-cell'];
                let cellContent = "---";

                if (isEyeballCell[index]) {
                    const nextRollRow = Math.floor((index + 1) / 3) + 1;
                    const nextRollCol = String.fromCharCode('A'.charCodeAt(0) + ((index + 1) % 3));
                    const nextRollAddress = `${nextRollCol}${nextRollRow}`;
                    cellContent = `<span class="eyeball-text">${nextRollAddress})目玉</span>`;
                } else if (reGachaItems[index] !== "---") {
                     const nextIndex = index + 4;
                     const nextRollRow = Math.floor((nextIndex) / 3) + 1;
                     const nextRollCol = String.fromCharCode('A'.charCodeAt(0) + (nextIndex % 3));
                     const nextRollAddress = `${nextRollCol}${nextRollRow}`;
                     cellContent = `${itemNameMaster[items[index]]}▼<br>${nextRollAddress})${reGachaItems[index]}`;
                } else {
                     cellContent = itemNameMaster[items[index]] || '---';
                }

                table += `<td class="${classList.join(' ')}">${cellContent}</td>`;
            }
            
            let gCellClass = 're-gacha-cell';
            let gCellContent = '';
            if (r < 10) {
                gCellClass += ' g-ten-pull-highlight';
                gCellContent = tenPullRows[r] || '';
                if (gCellContent && gCellContent.includes('目玉')) {
                    gCellContent = `<span class="eyeball-text">${gCellContent}</span>`;
                }
            } else {
                gCellContent = '';
            }

            table += `<td class="${gCellClass}">${gCellContent}</td>`;

            table += '</tr>';
        }
        
        table += '</tbody></table>';
        resultTableContainer.innerHTML = table;
    }

    runSimulationAndDisplay();
  </script>
</body>
</html>
