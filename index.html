<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>イベロ</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.4;
            padding: 15px;
            max-width: 1200px;
            margin: 0 auto;
            background-color: #f4f7f9;
            color: #333;
            font-size: 14px;
        }
        .container {
            background: #fff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #004085;
            font-size: 1.8rem;
            border-bottom: 3px solid #e9ecef;
            padding-bottom: 8px;
            margin-top: 0;
            text-align: center;
        }
        .controls {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            gap: 15px;
            margin-bottom: 25px;
            padding: 12px;
            background-color: #f9fbfd;
            border-radius: 8px;
        }
        .input-item {
            flex: 1 1 200px;
            display: flex;
            flex-direction: column;
        }
        label {
            font-weight: 600;
            margin-bottom: 6px;
            color: #555;
        }
        input[type="number"],
        select {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 0.9rem;
            width: 100%;
            box-sizing: border-box;
            transition: border-color 0.3s;
        }
        input[type="number"]:focus,
        select:focus {
            outline: none;
            border-color: #007bff;
        }
        button {
            background-color: #007bff;
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            transition: background-color 0.3s ease, transform 0.2s ease;
            width: 100%;
        }
        button:hover {
            background-color: #0056b3;
            transform: translateY(-2px);
        }
        #result-container {
            margin-top: 25px;
        }
        #result-table-container {
            overflow-x: auto;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }
        table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }
        th, td {
            padding: 8px 4px;
            text-align: center;
            border: 1px solid #e0e0e0;
            word-break: break-word;
            font-size: 0.7rem;
        }
        th {
            background-color: #f0f4f7;
            color: #444;
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        td {
            background-color: #fff;
        }
        .row-number-header {
            font-family: Arial, sans-serif;
            font-weight: bold;
            width: 40px;
            cursor: pointer;
        }
        .eyeball-text {
            color: #d9534f;
            font-weight: bold;
        }
        .re-gacha-cell {
            line-height: 1.2;
        }
        .path-cell {
            background-color: #e6ffe6 !important;
        }
        .g-ten-pull-highlight {
            background-color: #fffacd;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>イベロ</h1>
    <div class="input-group">
        <div class="controls">
            <div class="input-item">
                <label for="gachaIdSelector">Gacha</label>
                <select id="gachaIdSelector">
                    <option value="34">34: ハロウィン</option>
                    <option value="42" selected>42: 1.1億DL記念</option>
                </select>
            </div>
            <div class="input-item">
                <label for="seedInput">SEED</label>
                <input type="number" id="seedInput" value="123456789">
            </div>
            <div class="input-item">
                <label for="guaranteedRollsInput">最初の確定枠までのロール数</label>
                <input type="number" id="guaranteedRollsInput" value="30" min="1">
            </div>
            <div class="input-item" style="display: flex; align-items: flex-end;">
                <button id="executeButton">更新</button>
            </div>
        </div>
    </div>
    
    <div id="result-container">
        <div id="output"></div>
        <div id="result-table-container"></div>
    </div>
</div>

<script>
    function xorshift32(seed) {
        let x = seed;
        x ^= x << 13;
        x ^= x >>> 17;
        x ^= x << 15;
        return x >>> 0;
    }

    const gachaMaster = {
        '34': {
            name: 'ハロウィン',
            targetRate: 600,
            rarityRates: { '0': 2000, '1': 5000, '2': 3000, '3': 0, '4': 0 },
            rarityItems: {
                '0': { itemCounts: 1, itemNo: [10] },
                '1': { itemCounts: 4, itemNo: [0, 3, 11, 12] },
                '2': { itemCounts: 4, itemNo: [2, 4, 5, 14] },
                '3': { itemCounts: 0, itemNo: [] },
                '4': { itemCounts: 0, itemNo: [] }
            }
        },
        '42': {
            name: '1.1億DL記念',
            targetRate: 500,
            rarityRates: { '0': 1000, '1': 5000, '2': 3000, '3': 1000, '4': 0 },
            rarityItems: {
                '0': { itemCounts: 1, itemNo: [10] },
                '1': { itemCounts: 4, itemNo: [0, 3, 11, 12] },
                '2': { itemCounts: 4, itemNo: [2, 4, 5, 14] },
                '3': { itemCounts: 3, itemNo: [375, 381, 689] },
                '4': { itemCounts: 0, itemNo: [] }
            }
        }
    };

    const itemMaster = {
        0: "スピダ",
        1: "トレレ",
        2: "ネコボン",
        3: "ニャンピュ",
        4: "おかめ",
        5: "スニャ",
        10: "5千XP",
        11: "1万XP",
        12: "3万XP",
        14: "10万XP",
        375: "記念ネコ",
        381: "ねこ農家",
        689: "石の上にも10年ネコ"
    };

    const itemNameToId = {
        "スピダ": 0,
        "トレレ": 1,
        "ネコボン": 2,
        "ニャンピュ": 3,
        "おかめ": 4,
        "スニャ": 5,
        "5千XP": 10,
        "1万XP": 11,
        "3万XP": 12,
        "10万XP": 14,
        "記念ネコ": 375,
        "ねこ農家": 381,
        "石の上にも10年ネコ": 689
    };
    
    const seedInput = document.getElementById('seedInput');
    const gachaIdSelector = document.getElementById('gachaIdSelector');
    const guaranteedRollsInput = document.getElementById('guaranteedRollsInput');
    const executeButton = document.getElementById('executeButton');
    const output = document.getElementById('output');
    const resultTableContainer = document.getElementById('result-table-container');

    let forceReGachaMode = false;

    executeButton.addEventListener('click', () => {
        runSimulationAndDisplay();
    });

    // 10連ガチャ専用のシミュレーション関数
    function simulateTenPull(seed, gacha, firstGuaranteedRolls) {
        let currentSeed = seed + 9; // 10連分の乱数を先に消費するために+9
        let results = [];
        let lastActualItemId = -1;
        
        for (let i = 0; i < 10; i++) {
            let rollResult = { item: '---', isEyeball: false, reGachaItem: null };

            // 確定枠の処理
            if (i === firstGuaranteedRolls - 1) {
                rollResult.item = '目玉(確定)';
                rollResult.isEyeball = true;
                results.push(rollResult);
                lastActualItemId = -1;
                continue;
            }

            // 通常抽選
            currentSeed = xorshift32(currentSeed); // 乱数消費1: 目玉判定
            const isHit = (currentSeed % 10000) < gacha.targetRate;
            
            if (isHit) {
                rollResult.item = '目玉';
                rollResult.isEyeball = true;
                results.push(rollResult);
                lastActualItemId = -1;
                continue;
            }
            
            // レアリティ抽選
            currentSeed = xorshift32(currentSeed); // 乱数消費2: レアリティ判定
            const raritySeed = currentSeed % 10000;
            let rarityId;
            if (raritySeed < gacha.rarityRates['0']) { rarityId = 0; }
            else if (raritySeed < gacha.rarityRates['0'] + gacha.rarityRates['1']) { rarityId = 1; }
            else if (raritySeed < gacha.rarityRates['0'] + gacha.rarityRates['1'] + gacha.rarityRates['2']) { rarityId = 2; }
            else if (raritySeed < gacha.rarityRates['0'] + gacha.rarityRates['1'] + gacha.rarityRates['2'] + gacha.rarityRates['3']) { rarityId = 3; }
            else { rarityId = 4; }

            // アイテム抽選
            currentSeed = xorshift32(currentSeed); // 乱数消費3: アイテム判定
            const itemInfo = gacha.rarityItems[rarityId];
            if (itemInfo.itemCounts > 0) {
                const itemOffset = currentSeed % itemInfo.itemCounts;
                const itemId = itemInfo.itemNo[itemOffset];
                rollResult.item = itemMaster[itemId];
                
                // 再抽選判定 (レアリティ1 かつ直前のアイテムと重複)
                if (rarityId === 1 && itemInfo.itemCounts >= 2 && lastActualItemId === itemId) {
                    currentSeed = xorshift32(currentSeed); // 乱数消費4: 再抽選判定
                    const reGachaSeed = currentSeed;
                    const originalItemNoList = [...itemInfo.itemNo];
                    const itemIndex = originalItemNoList.indexOf(itemId);
                    if (itemIndex > -1) {
                        originalItemNoList.splice(itemIndex, 1);
                    }
                    const reGachaOffset = reGachaSeed % originalItemNoList.length;
                    const reGachaItemId = originalItemNoList[reGachaOffset];
                    
                    rollResult.reGachaItem = itemMaster[reGachaItemId];
                    lastActualItemId = reGachaItemId;
                } else {
                    lastActualItemId = itemId;
                }
            }
            results.push(rollResult);
        }
        
        return { results, nextSeed: currentSeed };
    }

    function runSimulationAndDisplay() {
        const seedValue = parseInt(seedInput.value, 10);
        const selectedGachaId = gachaIdSelector.value;
        const firstGuaranteedRolls = parseInt(guaranteedRollsInput.value, 10) || 30;

        if (isNaN(seedValue)) {
            output.textContent = '有効な数値を入力してください。';
            return;
        }

        const gacha = gachaMaster[selectedGachaId];
        if (!gacha) {
            output.textContent = '無効なガチャIDです。';
            return;
        }

        let xorshiftArray = [];
        let moduloArray = [];
        let currentSeed = seedValue;
        for (let i = 0; i < 1000; i++) {
            currentSeed = xorshift32(currentSeed);
            xorshiftArray.push(currentSeed);
            moduloArray.push(currentSeed % 10000);
        }
        
        const rates = gacha.rarityRates;
        const thresholds = {
            '0': rates['0'],
            '1': rates['0'] + rates['1'],
            '2': rates['0'] + rates['1'] + rates['2'],
            '3': rates['0'] + rates['1'] + rates['2'] + rates['3'],
            '4': 10000
        };

        let items = new Array(300).fill(-1);
        let rarities = new Array(300).fill(-1);
        let isEyeballCell = new Array(300).fill(false);
        let reGachaItems = new Array(300).fill("---");
        
        // すべてのセルに対して抽選結果を計算
        for (let i = 0; i < 300; i++) {
            const hitSeedIndex = i;
            const raritySeedIndex = i + 1;
            const itemSeedIndex = i + 2;

            if (itemSeedIndex >= xorshiftArray.length) continue;

            const isHit = (moduloArray[hitSeedIndex] < gacha.targetRate);
            isEyeballCell[i] = isHit;

            if (isHit) continue;
            
            const rarityId = (moduloArray[raritySeedIndex] < thresholds['0']) ? 0
                           : (moduloArray[raritySeedIndex] < thresholds['1']) ? 1
                           : (moduloArray[raritySeedIndex] < thresholds['2']) ? 2
                           : (moduloArray[raritySeedIndex] < thresholds['3']) ? 3 : 4;
            rarities[i] = rarityId;

            const itemInfo = gacha.rarityItems[rarityId];
            if (itemInfo.itemCounts > 0) {
                const itemOffset = xorshiftArray[itemSeedIndex] % itemInfo.itemCounts;
                items[i] = itemInfo.itemNo[itemOffset];
            }
        }
        
        // 抽選経路を追跡し、再抽選アイテムを決定
        let path = [];
        let pathCurrentIndex = 0;
        let lastActualItemId = -1;

        while (pathCurrentIndex < 300) {
            path.push(pathCurrentIndex);
            
            const isHit = isEyeballCell[pathCurrentIndex];
            
            if (isHit) {
                pathCurrentIndex += 1;
                lastActualItemId = -1;
                continue;
            }

            const currentItemId = items[pathCurrentIndex];
            const rarityId = rarities[pathCurrentIndex];
            const itemInfo = gacha.rarityItems[rarityId];

            if (rarityId === 1 && itemInfo.itemCounts >= 2 && lastActualItemId === currentItemId) {
                const reGachaSeedIndex = pathCurrentIndex + 3;
                if (reGachaSeedIndex < xorshiftArray.length) {
                    const originalItemNoList = [...itemInfo.itemNo];
                    const itemIndex = originalItemNoList.indexOf(currentItemId);
                    if (itemIndex > -1) {
                        originalItemNoList.splice(itemIndex, 1);
                    }
                    const newDivisor = originalItemNoList.length;
                    const seedForReGacha = xorshiftArray[reGachaSeedIndex];
                    const reGachaOffset = seedForReGacha % newDivisor;
                    const reGachaItemId = originalItemNoList[reGachaOffset];
                    reGachaItems[pathCurrentIndex] = itemMaster[reGachaItemId];
                    
                    lastActualItemId = reGachaItemId;
                    pathCurrentIndex += 4;
                }
            } else {
                lastActualItemId = currentItemId;
                pathCurrentIndex += 3;
            }
        }
        
        // 10連ガチャの結果を新しい関数で生成
        const { results: tenPullResults, nextSeed: tenPullNextSeed } = simulateTenPull(seedValue, gacha, firstGuaranteedRolls);

        // G列の最後のセルに次のSEEDアドレスを表示
        const nextRollIndex = xorshiftArray.indexOf(tenPullNextSeed);
        const nextRollRow = Math.floor(nextRollIndex / 3) + 1;
        const nextRollCol = String.fromCharCode('A'.charCodeAt(0) + (nextRollIndex % 3));
        const nextRollAddress = `${nextRollCol}${nextRollRow}`;
        
        // テーブル表示用に整形
        const tenPullRows = tenPullResults.map(result => {
            if (result.isEyeball) {
                return result.item;
            } else if (result.reGachaItem) {
                return `${result.item}▼<br>${result.reGachaItem}`;
            } else {
                return result.item;
            }
        });
        
        // 最後のセルは特別に処理
        const originalG9Content = tenPullRows[9] || '---';
        const newG9Display = `${nextRollAddress}) ${originalG9Content.replace(/<br>/g, '')}`;
        tenPullRows[9] = newG9Display;

        output.innerHTML = '';
        createAndDisplayTable(items, rarities, isEyeballCell, path, tenPullRows, reGachaItems, selectedGachaId);
    }
    
    function createAndDisplayTable(items, rarities, isEyeballCell, path, tenPullRows, reGachaItems, gachaId) {
        let table = '<table><thead><tr><th class="row-number-header">❐</th><th>A</th><th>B</th><th>C</th><th>G</th></tr></thead><tbody>';
        const pathSet = new Set(path);

        for (let r = 0; r < 100; r++) {
            table += `<tr><td>${r + 1}</td>`;
            for (let c = 0; c < 3; c++) {
                const index = r * 3 + c;
                let classList = ['re-gacha-cell'];
                let cellContent = "---";
                
                if (pathSet.has(index)) {
                    classList.push('path-cell');
                }

                if (isEyeballCell[index]) {
                    const nextRollRow = Math.floor((index + 1) / 3) + 1;
                    const nextRollCol = String.fromCharCode('A'.charCodeAt(0) + ((index + 1) % 3));
                    const nextRollAddress = `${nextRollCol}${nextRollRow}`;
                    cellContent = `<span class="eyeball-text">${nextRollAddress})目玉</span>`;
                } else if (reGachaItems[index] !== "---") {
                    const rarityId = Object.keys(gachaMaster[gachaId].rarityItems).find(key => gachaMaster[gachaId].rarityItems[key].itemNo.includes(itemNameToId[reGachaItems[index]]));
                    const nextIndex = index + 4;
                    const nextRollRow = Math.floor((nextIndex) / 3) + 1;
                    const nextRollCol = String.fromCharCode('A'.charCodeAt(0) + (nextIndex % 3));
                    const nextRollAddress = `${nextRollCol}${nextRollRow}`;
                    
                    let reGachaItemName = reGachaItems[index];
                    if (rarityId == 3) {
                        reGachaItemName = `<span class="eyeball-text">${reGachaItemName}</span>`;
                    }
                    cellContent = `${itemMaster[items[index]]}▼<br>${nextRollAddress})${reGachaItemName}`;
                } else if (items[index] !== -1) { // 着色されていないセルにもアイテム名を表示する
                    cellContent = itemMaster[items[index]] ? itemMaster[items[index]] : '---';
                    const rarityId = Object.keys(gachaMaster[gachaId].rarityItems).find(key => gachaMaster[gachaId].rarityItems[key].itemNo.includes(items[index]));
                    if (rarityId == 3) {
                        cellContent = `<span class="eyeball-text">${cellContent}</span>`;
                    }
                }

                table += `<td class="${classList.join(' ')}">${cellContent}</td>`;
            }
            
            let gCellClass = 're-gacha-cell';
            let gCellContent = '';
            if (r < 10) {
                gCellClass += ' g-ten-pull-highlight';
                gCellContent = tenPullRows[r] || '';
                
                if (gCellContent && (gCellContent.includes('目玉') || gCellContent.includes('記念ネコ') || gCellContent.includes('ねこ農家') || gCellContent.includes('石の上にも10年ネコ'))) {
                    gCellContent = `<span class="eyeball-text">${gCellContent}</span>`;
                }
            } else {
                gCellContent = '';
            }

            table += `<td class="${gCellClass}">${gCellContent}</td>`;
            table += '</tr>';
        }
        
        table += '</tbody></table>';
        resultTableContainer.innerHTML = table;

        const rowNumberHeader = document.querySelector('.row-number-header');
        if (rowNumberHeader) {
            rowNumberHeader.addEventListener('click', () => {
                forceReGachaMode = !forceReGachaMode;
                runSimulationAndDisplay();
            });
        }
    }

    runSimulationAndDisplay();
</script>
</body>
</html>
