<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>イベントガチャロールズ</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.2;
            padding: 10px;
            max-width: 800px;
            margin: 0 auto;
            background-color: #f4f7f9;
            color: #333;
            font-size: 10px;
        }
        .container {
            background: #fff;
            padding: 10px;
            border-radius: 12px;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #004085;
            font-size: 1rem;
            border-bottom: 1px solid #e9ecef;
            padding-bottom: 3px;
            margin-top: 0;
            text-align: center;
        }

        .controls {
            display: flex;
            flex-direction: column; /* これがキー */
            gap: 10px; /* 行間の隙間 */
            margin-bottom: 15px;
            padding: 6px;
            background-color: #f9fbfd;
            border-radius: 4px;
        }

        /* 各行のスタイル */
        .row {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            gap: 5px;
        }

        /* 各入力アイテムのスタイル */
        .input-item {
            flex: 1 1 150px;
            display: flex;
            flex-direction: row;
        }

        /* SEED入力項目専用のスタイル */
        .input-item-seed {
            display: flex;
            flex-direction: row;
        }
        
        /* SEED入力窓とボタンを横並びにするためのスタイル */
        .seed-input-group {
            display: flex;
            align-items: center;
            gap: 5px;
            flex 1 1 200px; /* 最小幅を200pxに設定 */
        }

        label {
            font-weight: 600;
            margin-bottom: 3px;
            color: #555;
        }

        input[type="number"],
        select {
            padding: 3px;
            border: 1px solid #ccc;
            border-radius: 3px;
            font-size: 0.8rem;
            width: 100%;
            box-sizing: border-box;
            transition: border-color 0.3s;
        }
        input[type="number"]:focus,
        select:focus {
            outline: none;
            border-color: #007bff;
        }

        /* ボタンのスタイルを調整 */
        button {
            flex-shrink: 0;
            width: auto;
            padding: 5px 10px;
            background-color: #007bff;
            color: #fff;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: bold;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }
        button:hover {
            background-color: #0056b3;
            transform: translateY(-2px);
        }

        #result-container {
            margin-top: 25px;
        }
        #result-table-container {
            overflow-x: auto;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }
        table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }
        th, td {
            padding: 5px;
            text-align: center;
            border: 1px solid #e0e0e0;
            word-break: break-word;
            font-size: 0.8rem;
        }
        th {
            background-color: #f0f4f7;
            color: #444;
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        td {
            background-color: #fff;
        }
        .row-number-header {
            font-family: Arial, sans-serif;
            font-weight: bold;
            width: 40px;
            cursor: pointer;
        }
        .featuredItem-text {
            color: #d9534f;
            font-weight: bold;
        }
        .re-gacha-cell {
            line-height: 1.2;
        }
        .path-cell {
            background-color: #e6ffe6 !important;
        }
        .g-ten-pull-highlight {
            background-color: #fffacd;
        }

        /* すべてのリンクの色を黒に設定し、下線をなくす */
        a {
            color: inherit;
            text-decoration: none;
        }

        #gachaIdSelector {width: 200px; /* ここに任意の幅を指定 */}
        #guaranteedRollsInput {width: 50px; /* ここに任意の幅を指定 */}

    </style>
</head>
<body>

<div class="container">
    <h1>イベントガチャロールズ</h1>
    <div class="input-group">
        <div class="controls">
            <div class="row">
                <div class="input-item">
                    <label for="gachaIdSelector">Gacha</label>
                    <select id="gachaIdSelector">
                        <option value="34">34: ハロウィン</option>
                        <option value="42" selected>42: 1.1億DL記念</option>
                    </select>
                </div>
                <div class="input-item">
                    <label for="guaranteedRollsInput">next guaranteed</label>
                    <select id="guaranteedRollsInput">
                    </select>
                </div>
            </div>

            <div class="row">
                <div class="input-item-seed">
                    <label for="seedInput">SEED</label>
                    <div class="seed-input-group">
                        <input type="number" id="seedInput" value="123456789">
                        <button id="executeButton">更新</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="result-container">
        <div id="output"></div>
        <div id="result-table-container"></div>
    </div>
</div>

<script>
    // グローバル変数として宣言
    let path = [];
    let xorshiftArray = [];
    let moduloArray = [];
    
    // URLからSEED値を取得して設定
    const params = new URLSearchParams(window.location.search);
    const urlSeed = params.get('seed');
    if (urlSeed) {
        document.getElementById('seedInput').value = urlSeed;
    }
    
    function xorshift32(seed) {
        let x = seed;
        x ^= x << 13;
        x ^= x >>> 17;
        x ^= x << 15;
        return x >>> 0;
    }
    
    // --- ユーティリティ関数 ---
    function getItemIdByName(name) {
        for (const id in itemMaster) {
            if (itemMaster[id] === name) {
                return parseInt(id, 10);
            }
        }
        return undefined;
    }

    const gachaMaster = {
        '34': {
            name: 'ハロウィン',
            featuredItemRate: 600,
            featuredItemStock: 5,
            rarityRates: { '0': 2000, '1': 5000, '2': 3000, '3': 0, '4': 0 },
            rarityItems: { '0': [10], '1': [0, 3, 11, 12], '2': [2, 4, 5, 14], '3': [], '4': [] }
        },
        '42': {
            name: '1.1億DL記念',
            featuredItemRate: 500,
            featuredItemStock: 5,
            rarityRates: { '0': 1000, '1': 5000, '2': 3000, '3': 1000, '4': 0 },
            rarityItems: { '0': [10], '1': [0, 3, 11, 12], '2': [2, 4, 5, 14], '3': [375, 381, 689], '4': [] }
        }
    };

    const itemMaster = {
        0: "スピダ",
        1: "トレレ",
        2: "ネコボン",
        3: "ニャンピュ",
        4: "おかめ",
        5: "スニャ",
        10: "5千XP",
        11: "1万XP",
        12: "3万XP",
        14: "10万XP",
        375: "記念ネコ",
        381: "ねこ農家",
        689: "石の上にも10年ネコ"
    };
    
    const seedInput = document.getElementById('seedInput');
    const gachaIdSelector = document.getElementById('gachaIdSelector');
    const guaranteedRollsInput = document.getElementById('guaranteedRollsInput');
    const executeButton = document.getElementById('executeButton');
    const output = document.getElementById('output');
    const resultTableContainer = document.getElementById('result-table-container');

    let forceReGachaMode = false;

    // ガチャの種類が変更されたときに実行
    gachaIdSelector.addEventListener('change', () => {
        runSimulationAndDisplay();
    });

    // 更新ボタンがクリックされたときに実行
    executeButton.addEventListener('click', () => {
        runSimulationAndDisplay();
    });

    // next guaranteedの選択肢を1から30まで動的に生成
    const rollSelect = document.getElementById('guaranteedRollsInput');
    for (let i = 1; i <= 30; i++) {
        const option = document.createElement('option');
        option.value = i;
        option.textContent = i;
        rollSelect.appendChild(option);
    }
    guaranteedRollsInput.value = '30';
    guaranteedRollsInput.addEventListener('change', () => {
        runSimulationAndDisplay();
    });





    // シミュレーションを実行して結果を表示する関数
    function runSimulationAndDisplay() {
        const seedValue = parseInt(seedInput.value, 10);
        const selectedGachaId = gachaIdSelector.value;
        const firstGuaranteedRolls = parseInt(guaranteedRollsInput.value, 10) || 30;

        if (isNaN(seedValue)) {
            output.textContent = '有効な数値を入力してください。';
            return;
        }

        const gacha = gachaMaster[selectedGachaId];
        if (!gacha) {
            output.textContent = '無効なガチャIDです。';
            return;
        }
        
        // グローバル変数に値を設定
        xorshiftArray = [];
        moduloArray = [];
        let currentSeed = seedValue;
        for (let i = 0; i < 1000; i++) {
            currentSeed = xorshift32(currentSeed);
            xorshiftArray.push(currentSeed);
            moduloArray.push(currentSeed % 10000);
        }
        
        const rates = gacha.rarityRates;
        const thresholds = {
            '0': rates['0'],
            '1': rates['0'] + rates['1'],
            '2': rates['0'] + rates['1'] + rates['2'],
            '3': rates['0'] + rates['1'] + rates['2'] + rates['3'],
            '4': 10000
        };

        let items = new Array(300).fill(-1);
        let rarities = new Array(300).fill(-1);
        let isfeaturedItemCell = new Array(300).fill(false);
        let reGachaItems = new Array(300).fill("---");
        let eligibleForReGacha = new Array(300).fill(false);
        
        for (let i = 0; i < 300; i++) {
            const hitSeedIndex = i;
            const raritySeedIndex = i + 1;
            const itemSeedIndex = i + 2;

            if (itemSeedIndex >= xorshiftArray.length) continue;

            const isHit = (moduloArray[hitSeedIndex] < gacha.featuredItemRate);
            isfeaturedItemCell[i] = isHit;

            if (isHit) continue;
            
            let rarityId;
            if (moduloArray[raritySeedIndex] < thresholds['0']) { rarityId = 0; }
            else if (moduloArray[raritySeedIndex] < thresholds['1']) { rarityId = 1; }
            else if (moduloArray[raritySeedIndex] < thresholds['2']) { rarityId = 2; }
            else if (moduloArray[raritySeedIndex] < thresholds['3']) { rarityId = 3; }
            else { rarityId = 4; }
            rarities[i] = rarityId;

            const itemInfo = gacha.rarityItems[rarityId];
            const itemCounts = itemInfo.length;
            if (itemCounts > 0) {
                const itemOffset = xorshiftArray[itemSeedIndex] % itemCounts;
                items[i] = itemInfo[itemOffset];
            }

            if (rarityId === 1 && itemCounts >= 2) {
                const reGachaSeedIndex = itemSeedIndex + 1;
                if (reGachaSeedIndex < xorshiftArray.length) {
                    const originalItemNoList = [...itemInfo];
                    const itemIndex = originalItemNoList.indexOf(items[i]);
                    if (itemIndex > -1) {
                        originalItemNoList.splice(itemIndex, 1);
                    }
                    const newDivisor = originalItemNoList.length;
                    const seedForReGacha = xorshiftArray[reGachaSeedIndex];
                    const reGachaOffset = seedForReGacha % newDivisor;
                    const reGachaItemId = originalItemNoList[reGachaOffset];
                    reGachaItems[i] = itemMaster[reGachaItemId];

                    let backOffset = 3; 
                    let tempIndex = i - 1;
                    while (tempIndex >= 0 && isfeaturedItemCell[tempIndex]) {
                        backOffset += 1;
                        tempIndex -= 1;
                    }

                    if (i >= backOffset) {
                    if(rarities[i] === 1){
                        if(items[i] === items[i - 3]){ 
                            eligibleForReGacha[i] = true;
                        }
                        if(items[i] === items[i - backOffset]){ 
                            eligibleForReGacha[i] = true;
                        }
                        else if(items[i] === getItemIdByName(reGachaItems[i - 1])){ 
                            if(eligibleForReGacha[i - backOffset - 1]){ 
                                eligibleForReGacha[i] = true;
                            }
                        }
                        else if(items[i] === getItemIdByName(reGachaItems[i - backOffset - 1])){ 
                            if(eligibleForReGacha[i - backOffset - 1]){ 
                                eligibleForReGacha[i] = true;
                            }
                        }
                    }
                    }
                    
                    reGachaItems[i] = "---"; 
                    if (forceReGachaMode || eligibleForReGacha[i]) {
                        reGachaItems[i] = itemMaster[reGachaItemId];
                    }
                }
            }
        }

        // 抽選経路の追跡と着色
        path = [];
        let currentCellIndex = 0;
        let lastActualItemId = -1; 
        while (currentCellIndex < 300) {
            if (currentCellIndex >= isfeaturedItemCell.length) break;
            path.push(currentCellIndex);

            if (isfeaturedItemCell[currentCellIndex]) {
                currentCellIndex += 1;
            } else if (eligibleForReGacha[currentCellIndex] && lastActualItemId === items[currentCellIndex]) {
                lastActualItemId = getItemIdByName(reGachaItems[currentCellIndex]);
                currentCellIndex += 4;
            } else {
                lastActualItemId = items[currentCellIndex];
                currentCellIndex += 3;
            }
        }
        
        // 10連ガチャの結果を計算
        const tenPullResults = new Array(10).fill(null); // G列の1行目～10行目のセルに表示する内容
        let tenPullSeedOffset = 9; // 10連ガチャの最初のロールのSEEDオフセット(0始まり)
        let nextIndexAfterTenPull = 0; // 10連ガチャ後の次のロールのインデックス
        
        for (let i = 0; i < 10; i++) { // 10連ガチャの各ロール
            if (i === firstGuaranteedRolls - 1) { // 確定枠
                tenPullResults[i] = '目玉(確定)'; // 確定枠を表示
                isfeaturedItemCell[tenPullSeedOffset] = true; // 確定枠のセルを目玉セルとしてマーク
                tenPullSeedOffset = tenPullSeedOffset - 1; // 次のロールのSEEDオフセットを更新
                continue; // 確定枠の場合は他の処理をスキップ
            }

            const isHit = (moduloArray[i] < gacha.featuredItemRate); // 目玉が出るかどうかを判定
            if (isHit) { // 目玉が出た場合
                tenPullResults[i] = '目玉'; // 目玉を表示
                isfeaturedItemCell[tenPullSeedOffset] = true; // 目玉セルとしてマーク
                nextIndexAfterTenPull = nextIndexAfterTenPull + 1; // 10連ガチャ後の次のロールのインデックスを更新
            } else { // 目玉が出なかった場合
                const raritySeedIndex = tenPullSeedOffset + 1; // レアリティ判定のSEEDインデックス
                const itemSeedIndex = tenPullSeedOffset + 2; // アイテム選択のSEEDインデックス
                
                let rarityId; // レアリティIDを決定
                if (moduloArray[raritySeedIndex] < thresholds['0']) { rarityId = 0; } // レアリティ0
                else if (moduloArray[raritySeedIndex] < thresholds['1']) { rarityId = 1; } // レアリティ1
                else if (moduloArray[raritySeedIndex] < thresholds['2']) { rarityId = 2; } // レアリティ2
                else if (moduloArray[raritySeedIndex] < thresholds['3']) { rarityId = 3; } // レアリティ3
                else { rarityId = 4; } // レアリティ4
                rarities[i] = rarityId; // レアリティを保存
                
                const itemInfo = gacha.rarityItems[rarityId]; // レアリティに応じたアイテムリスト
                const itemCounts = itemInfo.length; // アイテムの数
                let currentItemId = -1; // 現在のアイテムID
                let prevItemId = -1; // 前のロールのアイテムID
                let itemName = "---"; // アイテム名の初期化
                
                if (itemCounts > 0) { // アイテムが存在する場合
                    const itemOffset = xorshiftArray[itemSeedIndex] % itemCounts; // アイテムのオフセットを決定
                    currentItemId = itemInfo[itemOffset]; // 現在のアイテムIDを設定
                    itemName = itemMaster[currentItemId] || "不明"; // アイテム名を取得
                }
                
                let displayItemName = itemName; // 表示用のアイテム名
                
                // リガチャ（レア被り再抽選）の処理
                if (rarityId === 1 && itemCounts >= 2 && i > 0) { // レアリティ1でアイテムが2つ以上、かつ最初のロールでない場合
                    //const prevIndex = (tenPullResults[i - 1].includes("目玉")) ? i - 1 : i - 2; // 前のロールのインデックスを決定
                    
                    // リガチャ処理の直前に prevItemId を更新
                    if (tenPullResults[i - 1].includes("<br>")) { // 前のロールがリガチャであった場合
                    const prevReGachaItemName = tenPullResults[i - 1].split("<br>")[1].trim(); // リガチャ後のアイテム名を抽出
                    prevItemId = getItemIdByName(prevReGachaItemName); // アイテムIDを取得
                    } else {
                    prevItemId = getItemIdByName(tenPullResults[i - 1].replace(/<br>/g, '').trim()); // アイテムIDを取得
                    }

                    if (prevItemId === currentItemId) { // 前のロールと同じアイテムが出た場合
                        const reGachaSeedIndex = itemSeedIndex + 1; // リガチャのSEEDインデックス
                        const originalItemNoList = [...itemInfo]; // 元のアイテムリストをコピー
                        const itemIndex = originalItemNoList.indexOf(currentItemId); // 現在のアイテムのインデックスを取得
                        if (itemIndex > -1) { // アイテムがリストに存在する場合
                            originalItemNoList.splice(itemIndex, 1); // 重複を避けるためにリストから削除
                        }
                        const newDivisor = originalItemNoList.length; // 新しい除数を設定
                        const seedForReGacha = xorshiftArray[reGachaSeedIndex]; // リガチャ用のSEEDを取得
                        const reGachaOffset = seedForReGacha % newDivisor; // リガチャのオフセットを決定
                        const reGachaItemId = originalItemNoList[reGachaOffset]; // リガチャで選ばれたアイテムID
                        
                        // "<br>" を使用して再抽選前のアイテム名と再抽選後のアイテム名の両方を表示
                        displayItemName = `${itemName}<br>${itemMaster[reGachaItemId]}`; // 表示用のアイテム名を更新
                        tenPullSeedOffset += 3; // リガチャ分のSEEDオフセットを追加
                    } else {
                        tenPullSeedOffset += 2; // 通常のSEEDオフセットを追加
                    }
                } else {
                    tenPullSeedOffset += 2; // 通常のSEEDオフセットを追加
                }
                
                tenPullResults[i] = displayItemName;
            }
        }
        
        // G列の10行目のセルに次のSEEDアドレスを表示
        const nextRollIndex = tenPullSeedOffset + 1; // 10連ガチャ後の次のロールのインデックス
        const nextRollRow = Math.floor(nextRollIndex / 3) + 1; // 次のロールの行番号
        const nextRollCol = String.fromCharCode('A'.charCodeAt(0) + ((nextRollIndex) % 3)); // 次のロールの列文字
        const nextRollAddress = `${nextRollCol}${nextRollRow}`; // 次のロールのアドレス
        const originalG9Content = tenPullResults[9] || '---'; // 元のG列10行目の内容

        let newG9Display;
        if (originalG9Content.includes('<br>')) {
            // 改行が含まれる場合：再抽選前のアイテムと、再抽選後のアイテムのリンクを分ける
            const originalItem = originalG9Content.split('<br>')[0].trim();
            const reGachaItem = originalG9Content.split('<br>')[1].trim();
            newG9Display = `${originalItem}<br><a href="?seed=${xorshiftArray[nextRollIndex - 1]}" class="re-gacha-cell">${nextRollAddress}) ${reGachaItem}</a>`;
        } else {
            // 改行が含まれない場合：元のアイテム名全体をリンクにする
            //newG9Display = `<a href="?seed=${xorshiftArray[nextRollIndex - 1]}" class="re-gacha-cell">${nextRollAddress}) ${originalG9Content.trim()}</a>`;

            // 通常の場合
            if (rarities[9] == 3) {
                // レアリティが3の場合
                newG9Display = `<a href="?seed=${xorshiftArray[nextRollIndex - 1]}" class="re-gacha-cell"><span class="featuredItem-text">${nextRollAddress}) ${originalG9Content.trim()}</span></a>`;
            } else {
                // レアリティが3以外の場合
                newG9Display = `<a href="?seed=${xorshiftArray[nextRollIndex - 1]}" class="re-gacha-cell">${nextRollAddress}) ${originalG9Content.trim()}</a>`;
            }
        }
        tenPullResults[9] = newG9Display; // G列10行目の内容を更新

        

        // 単発Nロール後の10連に含まれる目玉数期待値の計算
        const expectedEyebollsArray = [];
        const numberArray = [];
        for (let start = 1; start <= 10; start++) {
            expectedEyebollsArray[start] = 0; // 初期化
            numberArray.push("<br>単発" + (start) + "ロール後(seed" + (path[start]) + "～)の(目玉出現枠)及び個数:<br>");
            for(let i = 0; i < 10; i++){
                // path配列の範囲内であることを確認
                if(path[start] + i >= path.length) break;
                if(moduloArray[path[start] + i] < gacha.featuredItemRate){
                    expectedEyebollsArray[start]++;
                    numberArray.push(" " + moduloArray[path[start] + i] + "■");
                } else {
                    numberArray.push(" " + moduloArray[path[start] + i]);
                }
            }

            // 確定枠の考慮(startが4のときは確定枠が4から10までの6枠、startが9のときは確定枠が10のみ)
            if(start <= firstGuaranteedRolls && firstGuaranteedRolls < start + 10){
                expectedEyebollsArray[start] = expectedEyebollsArray[start] + 1; // 確定枠分を加算
                numberArray.push((firstGuaranteedRolls - start) + "ロール目(確定枠)■");
                if(moduloArray[path[10]] < gacha.featuredItemRate){
                    expectedEyebollsArray[start] = expectedEyebollsArray[start]  - 1; // 確定枠が目玉の場合、期待値から1を減算
                }
            }
            
            numberArray.push(" / " + expectedEyebollsArray[start] + "個<br>");
        }
        
       // 表の上に確認用の表示
       const confirmationString = `Seed: ${seedValue} | ガチャID: ${selectedGachaId} | 確定枠: ${firstGuaranteedRolls}回目${numberArray}`;
       //output.innerHTML = confirmationString;

        // 結果の表を作成して表示
        createAndDisplayTable(items, rarities, isfeaturedItemCell, path, tenPullResults, reGachaItems, selectedGachaId, expectedEyebollsArray);
    
        // URLのクエリパラメータを更新
        const newUrl = `${window.location.protocol}//${window.location.host}${window.location.pathname}?seed=${seedValue}`;
        window.history.replaceState({ path: newUrl }, '', newUrl);
    }
    



    // 結果の表を作成して表示する関数
    function createAndDisplayTable(items, rarities, isfeaturedItemCell, path, tenPullRows, reGachaItems, gachaId, expectedEyebollsArray) {
        let table = '<table><thead><tr><th class="row-number-header">❐</th><th>A</th><th>B</th><th>C</th><th>G</th></tr></thead><tbody>';
        const pathSet = new Set(path);

        // 各行を生成
        for (let r = 0; r < 100; r++) {
            table += `<tr><td>${r + 1}</td>`; // 行番号セルの追加
            for (let c = 0; c < 3; c++) { // A, B, C列のセルを生成
                const index = r * 3 + c; // セルのインデックス
                if (index >= items.length) break; // インデックスが範囲外の場合は終了
                let classList = ['re-gacha-cell']; // セルの基本クラス
                let cellContent = "---"; // セルの内容初期化
                
                if (pathSet.has(index)) { // 抽選経路に含まれるセルの処理
                    classList.push('path-cell'); // 抽選経路セルのクラスを追加
                }

                if (isfeaturedItemCell[index]) { // 目玉セルの処理
                    const nextRollRow = Math.floor((index + 1) / 3) + 1; // 次のセルの行番号
                    const nextRollCol = String.fromCharCode('A'.charCodeAt(0) + ((index + 1) % 3)); // 次のセルの列文字
                    const nextRollAddress = `${nextRollCol}${nextRollRow}`; // 次のセルのアドレス
                    cellContent = `<a href="?seed=${xorshiftArray[index]}" class="featuredItem-text">${nextRollAddress})目玉</a>`; // 目玉セルの内容
                } else if (reGachaItems[index] !== "---") { // リガチャセルの処理
                    const nextIndex = index + 4; // 次のセルのインデックス
                    const nextRollRow = Math.floor((nextIndex) / 3) + 1; // 次のセルの行番号
                    const nextRollCol = String.fromCharCode('A'.charCodeAt(0) + (nextIndex % 3)); // 次のセルの列文字
                    const nextRollAddress = `${nextRollCol}${nextRollRow}`; // 次のセルのアドレス
                    
                    let reGachaItemName = reGachaItems[index]; // リガチャアイテム名
                    const reGachaItemId = getItemIdByName(reGachaItemName); // アイテムIDを取得
                    // レアリティをチェックして目玉と同じスタイル（赤フォント）を適用
                    const rarityId = Object.keys(gachaMaster[gachaId].rarityItems).find(key => gachaMaster[gachaId].rarityItems[key].includes(reGachaItemId));
                    cellContent = `<a href="?seed=${xorshiftArray[index + 2]}">${itemMaster[items[index]]}</a>
                    <br><a href="?seed=${xorshiftArray[index + 3]}">${nextRollAddress})${reGachaItemName}</a>`; // リガチャセルの内容
                } else { // 通常セルの処理
                    cellContent = itemMaster[items[index]] ? `<a href="?seed=${xorshiftArray[index + 2]}">${itemMaster[items[index]]}</a>` : '---'; // 通常セルの内容
                    // レアリティをチェックして目玉と同じスタイル（赤フォント）を適用
                    const rarityId = Object.keys(gachaMaster[gachaId].rarityItems).find(key => gachaMaster[gachaId].rarityItems[key].includes(items[index]));
                    if (rarityId == 3) { // レアリティ3の場合
                        cellContent = `<span class="featuredItem-text">${cellContent}</span>`; // 目玉と同じスタイルを適用
                    }
                }

                table += `<td class="${classList.join(' ')}">${cellContent}</td>`; // セルを追加
            }
            
            let gCellClass = 're-gacha-cell';
            let gCellContent = '';
            if (r < 10) {
                gCellClass += ' g-ten-pull-highlight';
                gCellContent = tenPullRows[r] || '';
                
                if (gCellContent && gCellContent.includes('目玉')) {
                    gCellContent = `<span class="featuredItem-text">${gCellContent}</span>`;
                } else if (gCellContent) {
                    const extractedItemName = gCellContent;
                    const extractedItemId = getItemIdByName(extractedItemName);
                    if (extractedItemId !== undefined) {
                        const rarityId = Object.keys(gachaMaster[gachaId].rarityItems).find(key => gachaMaster[gachaId].rarityItems[key].includes(extractedItemId));
                        if (rarityId == 3) {
                            gCellContent = `<span class="featuredItem-text">${gCellContent}</span>`;
                        }
                    }
                }
            } else if (r >= 10 && r < 20) {
                gCellContent = expectedEyebollsArray[r - 9] // 11行目以降は---
            } else {
                gCellContent = '';
            }

            table += `<td class="${gCellClass}">${gCellContent}</td>`;
            table += '</tr>';
        }
        
        table += '</tbody></table>';
        resultTableContainer.innerHTML = table;


    }

    // 初期表示
    runSimulationAndDisplay();
</script>
</body>
</html>
