<!DOCTYPE html>
 <html lang="ja">
 <head>
     <meta charset="UTF-8">
     <meta name="viewport" content="width=device-width, initial-scale=1.0">
     <title>イベロ</title>
     <style>
         body {
             font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
             line-height: 1.4;
             padding: 15px;
             max-width: 1200px;
             margin: 0 auto;
             background-color: #f4f7f9;
             color: #333;
             font-size: 14px;
         }
         .container {
             background: #fff;
             padding: 20px;
             border-radius: 12px;
             box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
         }
         h1 {
             color: #004085;
             font-size: 1.8rem;
             border-bottom: 3px solid #e9ecef;
             padding-bottom: 8px;
             margin-top: 0;
             text-align: center;
         }
         .controls {
             display: flex;
             flex-wrap: wrap;
             justify-content: space-between;
             gap: 15px;
             margin-bottom: 25px;
             padding: 12px;
             background-color: #f9fbfd;
             border-radius: 8px;
         }
         .input-item {
             flex: 1 1 200px;
             display: flex;
             flex-direction: column;
         }
         label {
             font-weight: 600;
             margin-bottom: 6px;
             color: #555;
         }
         input[type="number"],
         select {
             padding: 10px;
             border: 1px solid #ccc;
             border-radius: 6px;
             font-size: 0.9rem;
             width: 100%;
             box-sizing: border-box;
             transition: border-color 0.3s;
         }
         input[type="number"]:focus,
         select:focus {
             outline: none;
             border-color: #007bff;
         }
         button {
             background-color: #007bff;
             color: #fff;
             border: none;
             padding: 10px 20px;
             border-radius: 6px;
             cursor: pointer;
             font-size: 1rem;
             font-weight: bold;
             transition: background-color 0.3s ease, transform 0.2s ease;
             width: 100%;
         }
         button:hover {
             background-color: #0056b3;
             transform: translateY(-2px);
         }
         #result-container {
             margin-top: 25px;
         }
         #result-table-container {
             overflow-x: auto;
             border: 1px solid #e0e0e0;
             border-radius: 8px;
             box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
         }
         table {
             width: 100%;
             border-collapse: collapse;
             table-layout: fixed;
         }
         th, td {
             padding: 8px 4px;
             text-align: center;
             border: 1px solid #e0e0e0;
             word-break: break-word;
             font-size: 0.7rem;
         }
         th {
             background-color: #f0f4f7;
             color: #444;
             font-weight: 600;
             position: sticky;
             top: 0;
         }
         td {
             background-color: #fff;
         }
         .row-number-header {
             font-family: Arial, sans-serif;
             font-weight: bold;
             width: 40px;
             cursor: pointer;
         }
         .eyeball-text {
             color: #d9534f;
             font-weight: bold;
         }
         .re-gacha-cell {
             line-height: 1.2;
         }
         .path-cell {
             background-color: #e6ffe6 !important;
         }
         .g-ten-pull-highlight {
             background-color: #fffacd;
         }
     </style>
 </head>
 <body>

 <div class="container">
     <h1>イベロ</h1>
     <div class="input-group">
         <div class="controls">
             <div class="input-item">
                 <label for="gachaIdSelector">Gacha</label>
                 <select id="gachaIdSelector">
                     <option value="34">34: ハロウィン</option>
                     <option value="42" selected>42: 1.1億DL記念</option>
                 </select>
             </div>
             <div class="input-item">
                 <label for="seedInput">SEED</label>
                 <input type="number" id="seedInput" value="123456789">
             </div>
             <div class="input-item">
                 <label for="guaranteedRollsInput">最初の確定枠までのロール数</label>
                 <input type="number" id="guaranteedRollsInput" value="30" min="1">
             </div>
             <div class="input-item" style="display: flex; align-items: flex-end;">
                 <button id="executeButton">更新</button>
             </div>
         </div>
     </div>
     
     <div id="result-container">
         <div id="output"></div>
         <div id="result-table-container"></div>
     </div>
 </div>

 <script>
     function xorshift32(seed) {
         let x = seed;
         x ^= x << 13;
         x ^= x >>> 17;
         x ^= x << 15;
         return x >>> 0;
     }

     const gachaMaster = {
         '34': {
             name: 'ハロウィン',
             targetRate: 600,
             rarityRates: { '0': 2000, '1': 5000, '2': 3000, '3': 0, '4': 0 },
             rarityItems: {
                 '0': { itemNo: [10] },
                 '1': { itemNo: [0, 3, 11, 12] },
                 '2': { itemNo: [2, 4, 5, 14] },
                 '3': { itemNo: [] },
                 '4': { itemNo: [] }
             }
         },
         '42': {
             name: '1.1億DL記念',
             targetRate: 500,
             rarityRates: { '0': 1000, '1': 5000, '2': 3000, '3': 1000, '4': 0 },
             rarityItems: {
                 '0': { itemNo: [10] },
                 '1': { itemNo: [0, 3, 11, 12] },
                 '2': { itemNo: [2, 4, 5, 14] },
                 '3': { itemNo: [375, 381, 689] },
                 '4': { itemNo: [] }
             }
         }
     };

     const itemMaster = {
         0: "スピダ",
         1: "トレレ",
         2: "ネコボン",
         3: "ニャンピュ",
         4: "おかめ",
         5: "スニャ",
         10: "5千XP",
         11: "1万XP",
         12: "3万XP",
         14: "10万XP",
         375: "記念ネコ",
         381: "ねこ農家",
         689: "石の上にも10年ネコ"
     };

     const itemNameToId = {
         "スピダ": 0,
         "トレレ": 1,
         "ネコボン": 2,
         "ニャンピュ": 3,
         "おかめ": 4,
         "スニャ": 5,
         "5千XP": 10,
         "1万XP": 11,
         "3万XP": 12,
         "10万XP": 14,
         "記念ネコ": 375,
         "ねこ農家": 381,
         "石の上にも10年ネコ": 689
     };
     
     const seedInput = document.getElementById('seedInput');
     const gachaIdSelector = document.getElementById('gachaIdSelector');
     const guaranteedRollsInput = document.getElementById('guaranteedRollsInput');
     const executeButton = document.getElementById('executeButton');
     const output = document.getElementById('output');
     const resultTableContainer = document.getElementById('result-table-container');

     let forceReGachaMode = false;

     executeButton.addEventListener('click', () => {
         runSimulationAndDisplay();
     });

     function runSimulationAndDisplay() {
         const seedValue = parseInt(seedInput.value, 10);
         const selectedGachaId = gachaIdSelector.value;
         const firstGuaranteedRolls = parseInt(guaranteedRollsInput.value, 10) || 30;

         if (isNaN(seedValue)) {
             output.textContent = '有効な数値を入力してください。';
             return;
         }

         const gacha = gachaMaster[selectedGachaId];
         if (!gacha) {
             output.textContent = '無効なガチャIDです。';
             return;
         }

         let xorshiftArray = [];
         let moduloArray = [];
         let currentSeed = seedValue;
         for (let i = 0; i < 1000; i++) {
             currentSeed = xorshift32(currentSeed);
             xorshiftArray.push(currentSeed);
             moduloArray.push(currentSeed % 10000);
         }
         
         const rates = gacha.rarityRates;
         const thresholds = {
             '0': rates['0'],
             '1': rates['0'] + rates['1'],
             '2': rates['0'] + rates['1'] + rates['2'],
             '3': rates['0'] + rates['1'] + rates['2'] + rates['3'],
             '4': 10000
         };

         let items = new Array(300).fill(-1);
         let rarities = new Array(300).fill(-1);
         let isEyeballCell = new Array(300).fill(false);
         let reGachaItems = new Array(300).fill("---");
         let eligibleForReGacha = new Array(300).fill(false);
         let showReGacha = new Array(300).fill(false);
         
         for (let i = 0; i < 300; i++) {
             const hitSeedIndex = i;
             const raritySeedIndex = i + 1;
             const itemSeedIndex = i + 2;

             if (itemSeedIndex >= xorshiftArray.length) continue;

             const isHit = (moduloArray[hitSeedIndex] < gacha.targetRate);
             isEyeballCell[i] = isHit;

             if (isHit) continue;
             
             let rarityId;
             if (moduloArray[raritySeedIndex] < thresholds['0']) { rarityId = 0; }
             else if (moduloArray[raritySeedIndex] < thresholds['1']) { rarityId = 1; }
             else if (moduloArray[raritySeedIndex] < thresholds['2']) { rarityId = 2; }
             else if (moduloArray[raritySeedIndex] < thresholds['3']) { rarityId = 3; }
             else { rarityId = 4; }
             rarities[i] = rarityId;

             const itemInfo = gacha.rarityItems[rarityId];
             const itemCounts = itemInfo.itemNo.length;
             if (itemCounts > 0) {
                 const itemOffset = xorshiftArray[itemSeedIndex] % itemCounts;
                 items[i] = itemInfo.itemNo[itemOffset];
             }

             if (rarityId === 1 && itemCounts >= 2) {
                 const reGachaSeedIndex = itemSeedIndex + 1;
                 if (reGachaSeedIndex < xorshiftArray.length) {
                     const originalItemNoList = [...itemInfo.itemNo];
                     const itemIndex = originalItemNoList.indexOf(items[i]);
                     if (itemIndex > -1) {
                         originalItemNoList.splice(itemIndex, 1);
                     }
                     const newDivisor = originalItemNoList.length;
                     const seedForReGacha = xorshiftArray[reGachaSeedIndex];
                     const reGachaOffset = seedForReGacha % newDivisor;
                     const reGachaItemId = originalItemNoList[reGachaOffset];
                     reGachaItems[i] = itemMaster[reGachaItemId];

                     let backOffset = 3; 
                     let tempIndex = i - 1;
                     while (tempIndex >= 0 && isEyeballCell[tempIndex]) {
                         backOffset += 1;
                         tempIndex -= 1;
                     }

                     if (i >= backOffset) {
                      if(rarities[i] === 1){
                         if(items[i] === items[i - backOffset]){ 
                             showReGacha[i] = true;
                             eligibleForReGacha[i] = true;
                         }
                         else if(items[i] === reGachaItems[i - backOffset - 1]){ 
                             if(eligibleForReGacha[i - backOffset - 1]){ 
                             showReGacha[i] = true;}
                         }
                      }
                     }
                     
                     reGachaItems[i] = "---"; 
                     if (forceReGachaMode || showReGacha[i]) {
                         reGachaItems[i] = itemMaster[reGachaItemId];
                     }
                 }
             }
         }

         // 抽選経路の追跡と着色
         let path = [];
         let currentCellIndex = 0;
         let lastActualItemId = -1; 
         while (currentCellIndex < 300) {
             if (currentCellIndex >= isEyeballCell.length) break;
             path.push(currentCellIndex);

             if (isEyeballCell[currentCellIndex]) {
                 currentCellIndex += 1;
             } else if (rarities[currentCellIndex] === 1 && lastActualItemId === items[currentCellIndex]) {
                 lastActualItemId = itemNameToId[reGachaItems[currentCellIndex]];
                 currentCellIndex += 4;
             } else {
                 lastActualItemId = items[currentCellIndex];
                 currentCellIndex += 3;
             }
         }
         
         // 10連ガチャの結果を計算
         const tenPullResults = new Array(10).fill(null);
         let tenPullSeedOffset = 9; 
         
         for (let i = 0; i < 10; i++) {
             if (i === firstGuaranteedRolls - 1) {
                 tenPullResults[i] = '目玉(確定)';
                 tenPullSeedOffset = tenPullSeedOffset -1;
                 continue;
             }

             const isHit = (moduloArray[i] < gacha.targetRate);
             if (isHit) {
                 tenPullResults[i] = '目玉';
             } else {
                 const raritySeedIndex = tenPullSeedOffset + 1;
                 const itemSeedIndex = tenPullSeedOffset + 2;
                 
                 let rarityId;
                 if (moduloArray[raritySeedIndex] < thresholds['0']) { rarityId = 0; }
                 else if (moduloArray[raritySeedIndex] < thresholds['1']) { rarityId = 1; }
                 else if (moduloArray[raritySeedIndex] < thresholds['2']) { rarityId = 2; }
                 else if (moduloArray[raritySeedIndex] < thresholds['3']) { rarityId = 3; }
                 else { rarityId = 4; }
                 
                 const itemInfo = gacha.rarityItems[rarityId];
                 const itemCounts = itemInfo.itemNo.length;
                 let currentItemId = -1;
                 let itemName = "---";
                 
                 if (itemCounts > 0) {
                     const itemOffset = xorshiftArray[itemSeedIndex] % itemCounts;
                     currentItemId = itemInfo.itemNo[itemOffset];
                     itemName = itemMaster[currentItemId] || "不明";
                 }
                 
                 let displayItemName = itemName;
                 
                 if (rarityId === 1 && itemCounts >= 2 && i > 0) {
                     const prevIndex = (tenPullResults[i-1].includes("目玉")) ? i - 1 : i - 2;
                     let prevItemId;
                     if (tenPullResults[i-1].includes("▼")) {
                         const prevReGachaItemName = tenPullResults[i-1].split(")$")[1];
                         prevItemId = itemNameToId[prevReGachaItemName];
                     } else {
                         prevItemId = itemNameToId[tenPullResults[i-1].replace(/<br>/g, '').trim()];
                     }

                     if(prevItemId === currentItemId) {
                             const reGachaSeedIndex = itemSeedIndex + 1;
                             const originalItemNoList = [...itemInfo.itemNo];
                             const itemIndex = originalItemNoList.indexOf(currentItemId);
                             if (itemIndex > -1) {
                                 originalItemNoList.splice(itemIndex, 1);
                             }
                             const newDivisor = originalItemNoList.length;
                             const seedForReGacha = xorshiftArray[reGachaSeedIndex];
                             const reGachaOffset = seedForReGacha % newDivisor;
                             const reGachaItemId = originalItemNoList[reGachaOffset];
                             displayItemName = `${itemName}▼<br>${itemMaster[reGachaItemId]}`;
                             tenPullSeedOffset += 3;
                     } else {
                             tenPullSeedOffset += 2;
                     }

                 } else {
                     tenPullSeedOffset += 2;
                 }
                 
                 tenPullResults[i] = displayItemName;
             }
         }
         
         // G列の最後のセルに次のSEEDアドレスを表示
         const nextRollIndex = tenPullSeedOffset;
         const nextRollRow = Math.floor(nextRollIndex / 3) + 1;
         const nextRollCol = String.fromCharCode('A'.charCodeAt(0) + (nextRollIndex % 3));
         const nextRollAddress = `${nextRollCol}${nextRollRow}`;

         const originalG9Content = tenPullResults[9] || '---';
         const newG9Display = `${nextRollAddress}) ${originalG9Content.replace(/<br>/g, '')}`;
         tenPullResults[9] = newG9Display;

         output.innerHTML = '';
         createAndDisplayTable(items, rarities, isEyeballCell, path, tenPullResults, reGachaItems, selectedGachaId);
     }
     
     function createAndDisplayTable(items, rarities, isEyeballCell, path, tenPullRows, reGachaItems, gachaId) {
         let table = '<table><thead><tr><th class="row-number-header">❐</th><th>A</th><th>B</th><th>C</th><th>G</th></tr></thead><tbody>';
         const pathSet = new Set(path);

         for (let r = 0; r < 100; r++) {
             table += `<tr><td>${r + 1}</td>`;
             for (let c = 0; c < 3; c++) {
                 const index = r * 3 + c;
                 let classList = ['re-gacha-cell'];
                 let cellContent = "---";
                 
                 if (pathSet.has(index)) {
                     classList.push('path-cell');
                 }

                 if (isEyeballCell[index]) {
                     const nextRollRow = Math.floor((index + 1) / 3) + 1;
                     const nextRollCol = String.fromCharCode('A'.charCodeAt(0) + ((index + 1) % 3));
                     const nextRollAddress = `${nextRollCol}${nextRollRow}`;
                     cellContent = `<span class="eyeball-text">${nextRollAddress})目玉</span>`;
                 } else if (reGachaItems[index] !== "---") {
                     const nextIndex = index + 4;
                     const nextRollRow = Math.floor((nextIndex) / 3) + 1;
                     const nextRollCol = String.fromCharCode('A'.charCodeAt(0) + (nextIndex % 3));
                     const nextRollAddress = `${nextRollCol}${nextRollRow}`;
                     
                     let reGachaItemName = reGachaItems[index];
                     const reGachaItemId = itemNameToId[reGachaItemName];
                     const rarityId = Object.keys(gachaMaster[gachaId].rarityItems).find(key => gachaMaster[gachaId].rarityItems[key].itemNo.includes(reGachaItemId));
                     if (rarityId == 3) {
                         reGachaItemName = `<span class="eyeball-text">${reGachaItemName}</span>`;
                     }
                     cellContent = `${itemMaster[items[index]]}▼<br>${nextRollAddress})${reGachaItemName}`;
                 } else {
                     cellContent = itemMaster[items[index]] ? itemMaster[items[index]] : '---';
                     const rarityId = Object.keys(gachaMaster[gachaId].rarityItems).find(key => gachaMaster[gachaId].rarityItems[key].itemNo.includes(items[index]));
                     if (rarityId == 3) {
                         cellContent = `<span class="eyeball-text">${cellContent}</span>`;
                     }
                 }

                 table += `<td class="${classList.join(' ')}">${cellContent}</td>`;
             }
             
             let gCellClass = 're-gacha-cell';
             let gCellContent = '';
             if (r < 10) {
                 gCellClass += ' g-ten-pull-highlight';
                 gCellContent = tenPullRows[r] || '';
                 
                 if (gCellContent && gCellContent.includes('目玉')) {
                     gCellContent = `<span class="eyeball-text">${gCellContent}</span>`;
                 } else if (gCellContent) {
                     const extractedItemName = gCellContent.split(') ').pop().split('▼')[0].trim();
                     const extractedItemId = itemNameToId[extractedItemName];
                     if (extractedItemId !== undefined) {
                         const rarityId = Object.keys(gachaMaster[gachaId].rarityItems).find(key => gachaMaster[gachaId].rarityItems[key].itemNo.includes(extractedItemId));
                         if (rarityId == 3) {
                             gCellContent = `<span class="eyeball-text">${gCellContent}</span>`;
                         }
                     }
                 }
             } else {
                 gCellContent = '';
             }

             table += `<td class="${gCellClass}">${gCellContent}</td>`;
             table += '</tr>';
         }
         
         table += '</tbody></table>';
         resultTableContainer.innerHTML = table;

         const rowNumberHeader = document.querySelector('.row-number-header');
         if (rowNumberHeader) {
             rowNumberHeader.addEventListener('click', () => {
                 forceReGachaMode = !forceReGachaMode;
                 runSimulationAndDisplay();
             });
         }
     }

     runSimulationAndDisplay();
 </script>
 </body>
 </html>
