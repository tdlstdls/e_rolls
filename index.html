<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>イベロ</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      line-height: 1.6;
      padding: 10px;
      max-width: 1000px;
      margin: auto;
      background-color: #f0f2f5;
      color: #333;
      font-size: 16px;
    }
    .container {
      background: #fff;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    h1, h2, h3 {
      color: #004085;
      border-bottom: 2px solid #e9ecef;
      padding-bottom: 5px;
      font-size: 1.5rem;
    }
    .input-group {
      margin-bottom: 10px;
    }
    .controls {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 20px;
    }
    .controls .input-item {
      display: flex;
      flex-direction: column;
      flex: 1;
    }
    .controls .input-item label {
      font-weight: bold;
      margin-bottom: 5px;
      font-size: 1rem;
    }
    .controls .input-item input,
    .controls .input-item select {
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 1rem;
    }
    .controls button {
      width: 100%;
      padding: 12px 20px;
      margin-top: 10px;
    }
    button {
      background-color: #007bff;
      color: #fff;
      border: none;
      padding: 12px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: bold;
      transition: background-color 0.3s ease;
    }
    button:hover {
      background-color: #0056b3;
    }
    #result-container {
      margin-top: 20px;
    }
    #result-table-container {
      overflow-x: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      font-size: 0.8rem;
      min-width: 300px;
      table-layout: fixed;
    }
    th, td {
      padding: 6px; 
      text-align: center;
      border: 1px solid #ddd;
      word-break: break-all;
    }
    th {
      background-color: #f8ffa;
      font-weight: bold;
      color: #495057;
    }
    .row-number-header {
      cursor: pointer;
      font-family: Arial, sans-serif;
      font-size: 1.1em;
    }
    .re-gacha-cell {
      line-height: 1.2;
    }
    .eyeball-cell {
      color: red;
      font-weight: bold;
    }
    .path-cell {
      background-color: #e6ffe6 !important;
    }
    #cellCount {
        font-weight: bold;
        margin-top: 10px;
        font-size: 0.9rem;
    }
    .guaranteed-eyeball-cell {
        background-color: #ffe6e6 !important;
        font-weight: bold;
        color: #d9534f;
    }
    .guaranteed-cell-G {
        background-color: #ffe6e6 !important;
        font-weight: bold;
        color: #d9534f;
    }
    /* 列幅を均等に設定 */
    th:first-child, td:first-child {
        width: 10%;
    }
    th:nth-child(2), td:nth-child(2),
    th:nth-child(3), td:nth-child(3),
    th:nth-child(4), td:nth-child(4) {
        width: 30%;
    }
    /* PC表示時のレイアウト */
    @media (min-width: 768px) {
        .controls {
            flex-direction: row;
            align-items: flex-end;
            gap: 15px;
        }
        .controls button {
            width: auto;
            margin-top: 0;
        }
    }
    #tenPullResult {
      margin-top: 20px;
    }
    #tenPullResult h3 {
        margin-bottom: 5px;
    }
    #tenPullResult p {
        margin-bottom: 5px;
        font-weight: bold;
    }
  </style>
</head>
<body>

  <div class="container">
    <h1>イベロ</h1>
    
    <div class="controls">
      <div class="input-item">
        <label for="gachaIdSelector">Gacha</label>
        <select id="gachaIdSelector">
          <option value="34">34: ハロウィン</option>
        </select>
      </div>
      <div class="input-item">
        <label for="seedInput">SEED</label>
        <input type="number" id="seedInput" value="123456789">
      </div>
      <div class="input-item">
        <label for="guaranteedRollsInput">最初の確定枠までのロール数</label>
        <input type="number" id="guaranteedRollsInput" value="30" min="1">
      </div>
      <button id="executeButton">更新</button>
    </div>
    
    <div id="output"></div>

    <div id="tenPullResult"></div>

    <div id="result-container">
      <div id="result-table-container"></div>
      <div id="cellCount"></div>
    </div>
  </div>

  <script>
    function xorshift32(seed) {
      let x = seed;
      x ^= x << 13;
      x ^= x >>> 17;
      x ^= x << 15;
      return x >>> 0;
    }

    const gachaData = {
      '34': {
        name: 'ハロウィン',
        targetRate: 600,
        rarityRates: { '0': 2000, '1': 5000, '2': 3000, '3': 0, '4': 0 }
      }
    };

    const gachaMaster = {
      '34': {
        '0': { itemCounts: 1, itemNo: [10] },
        '1': { itemCounts: 4, itemNo: [0, 3, 11, 12] },
        '2': { itemCounts: 4, itemNo: [2, 4, 5, 14] },
        '3': { itemCounts: 0, itemNo: [] },
        '4': { itemCounts: 0, itemNo: [] }
      }
    };

    const itemNameMaster = {
      0: "スピダ",
      1: "トレレ",
      2: "ネコボン",
      3: "ニャンピュ",
      4: "おかめ",
      5: "スニャ",
      10: "5千XP",
      11: "1万XP",
      12: "3万XP",
      14: "10万XP"
    };

    const itemNameToId = {
      "スピダ": 0,
      "トレレ": 1,
      "ネコボン": 2,
      "ニャンピュ": 3,
      "おかめ": 4,
      "スニャ": 5,
      "5千XP": 10,
      "1万XP": 11,
      "3万XP": 12,
      "10万XP": 14
    };

    const seedInput = document.getElementById('seedInput');
    const gachaIdSelector = document.getElementById('gachaIdSelector');
    const guaranteedRollsInput = document.getElementById('guaranteedRollsInput');
    const executeButton = document.getElementById('executeButton');
    const output = document.getElementById('output');
    const resultTableContainer = document.getElementById('result-table-container');
    const cellCountDisplay = document.getElementById('cellCount');
    const tenPullResult = document.getElementById('tenPullResult');

    let forceReGachaMode = false;

    executeButton.addEventListener('click', () => {
        runSimulationAndDisplay();
    });

    function runSimulationAndDisplay() {
      const seedValue = parseInt(seedInput.value, 10);
      const firstGuaranteedRolls = parseInt(guaranteedRollsInput.value, 10) || 30;

      if (isNaN(seedValue)) {
        output.textContent = '有効な数値を入力してください。';
        return;
      }

      let xorshiftArray = [];
      let moduloArray = [];
      let currentSeed = seedValue;
      for (let i = 0; i < 400; i++) {
        currentSeed = xorshift32(currentSeed);
        xorshiftArray.push(currentSeed);
        moduloArray.push(currentSeed % 10000);
      }

      const selectedGachaId = gachaIdSelector.value;
      const gacha = gachaData[selectedGachaId];
      const master = gachaMaster[selectedGachaId];

      if (!gacha || !master) {
        output.textContent = '無効なガチャIDです。';
        return;
      }
      
      let items = new Array(300).fill(-1);
      let rarities = new Array(300).fill(-1);
      let isEyeballCell = new Array(300).fill(false);
      let reGachaItems = new Array(300).fill("---");
      
      const rates = gacha.rarityRates;
      const thresholds = {
        '0': rates['0'],
        '1': rates['0'] + rates['1'],
        '2': rates['0'] + rates['1'] + rates['2'],
        '3': rates['0'] + rates['1'] + rates['2'] + rates['3'],
        '4': 10000
      };
      
      // 全セルの抽選結果を計算
      for (let i = 0; i < 300; i++) {
        const hitSeedIndex = i;
        const isHit = (moduloArray[hitSeedIndex] < gacha.targetRate);
        isEyeballCell[i] = isHit;

        if (isHit) {
            continue;
        }

        const raritySeedIndex = i + 1;
        const itemSeedIndex = i + 2;

        if (itemSeedIndex >= xorshiftArray.length) {
            continue;
        }

        let rarityId;
        if (moduloArray[raritySeedIndex] < thresholds['0']) { rarityId = 0; }
        else if (moduloArray[raritySeedIndex] < thresholds['1']) { rarityId = 1; }
        else if (moduloArray[raritySeedIndex] < thresholds['2']) { rarityId = 2; }
        else if (moduloArray[raritySeedIndex] < thresholds['3']) { rarityId = 3; }
        else { rarityId = 4; }
        rarities[i] = rarityId;

        const itemInfo = master[rarityId];
        if (itemInfo.itemCounts > 0) {
          const itemOffset = xorshiftArray[itemSeedIndex] % itemInfo.itemCounts;
          items[i] = itemInfo.itemNo[itemOffset];
        }

        if (rarityId === 1 && itemInfo.itemCounts >= 2) {
            const reGachaSeedIndex = itemSeedIndex + 1;
            if (reGachaSeedIndex < xorshiftArray.length) {
                const originalItemNoList = [...itemInfo.itemNo];
                const itemIndex = originalItemNoList.indexOf(items[i]);
                if (itemIndex > -1) {
                    originalItemNoList.splice(itemIndex, 1);
                }
                const newDivisor = originalItemNoList.length;
                const seedForReGacha = xorshiftArray[reGachaSeedIndex];
                const reGachaOffset = seedForReGacha % newDivisor;
                const reGachaItemId = originalItemNoList[reGachaOffset];
                reGachaItems[i] = itemNameMaster[reGachaItemId];
            }
        }
      }

      // 抽選経路を追跡し、表示内容を確定
      let displayItems = new Array(300).fill("---");
      let isReGachaOccurred = new Array(300).fill(false);
      let path = [];
      let currentCellIndex = 0;
      let lastActualItemId = -1;
      
      while (currentCellIndex < 300) {
          path.push(currentCellIndex);
          
          if (isEyeballCell[currentCellIndex]) {
              const nextRollRow = Math.floor((currentCellIndex + 1) / 3) + 1;
              const nextRollCol = String.fromCharCode('A'.charCodeAt(0) + ((currentCellIndex + 1) % 3));
              const nextRollAddress = `${nextRollCol}${nextRollRow}`;
              displayItems[currentCellIndex] = `(${nextRollAddress})目玉`;
              lastActualItemId = -1;
              currentCellIndex += 1;
          } else {
              const currentItem = items[currentCellIndex];
              const currentItemName = itemNameMaster[currentItem] || "---";
              const currentReGachaItemName = reGachaItems[currentCellIndex];
              const rarityId = rarities[currentCellIndex];

              let isReGacha = false;
              if (rarityId === 1 && lastActualItemId === currentItem) {
                  isReGacha = true;
              }
              if (rarityId === 1 && forceReGachaMode) {
                  isReGacha = true;
              }
              
              if (isReGacha && currentReGachaItemName !== "---") {
                  isReGachaOccurred[currentCellIndex] = true;
                  displayItems[currentCellIndex] = `${currentItemName}▼<br>${currentReGachaItemName}`;
                  lastActualItemId = itemNameToId[currentReGachaItemName];
                  currentCellIndex += 4;
              } else {
                  displayItems[currentCellIndex] = currentItemName;
                  lastActualItemId = currentItem;
                  currentCellIndex += 3;
              }
          }
      }
      
      const coloredCellCount = path.length;
      let guaranteedCount = 0;
      const guaranteedEyeballIndices = [];
      let nextGuaranteedRoll = firstGuaranteedRolls;

      for (let i = 0; i < coloredCellCount; i++) {
        const index = path[i];
        if ((i + 1) === nextGuaranteedRoll) {
          guaranteedEyeballIndices.push(index);
          guaranteedCount++;
          let originalItemName;
          if (isEyeballCell[index]) {
            originalItemName = '目玉';
          } else if (isReGachaOccurred[index]) {
            originalItemName = reGachaItems[index];
          } else {
            originalItemName = itemNameMaster[items[index]] || "不明";
          }
          displayItems[index] = `目玉(確定)／${originalItemName}`;
          nextGuaranteedRoll += 30;
        }
      }

      // 非着色セルも表示
      for (let i = 0; i < 300; i++) {
          if (!path.includes(i)) {
              let itemName = itemNameMaster[items[i]] || "---";
              if (isEyeballCell[i]) {
                  itemName = "目玉";
              }
              displayItems[i] = itemName;
          }
      }


      output.innerHTML = '';
      createAndDisplayTable(displayItems, path, isEyeballCell, guaranteedEyeballIndices, moduloArray, gacha);
      
      const normalCount = coloredCellCount;
      const totalCount = normalCount + guaranteedCount;
      cellCountDisplay.innerHTML = `(通常ロール数) ${normalCount} + (確定ロール数) ${guaranteedCount} = (合計ロール数) ${totalCount}`;

      // 10連ガチャの目玉判定結果を生成
      let tenPullHtml = '<h3>10連ガチャ結果</h3>';
      
      const guaranteedRoll = (firstGuaranteedRolls > 0 && firstGuaranteedRolls <= 10) ? firstGuaranteedRolls : -1;
      
      // 目玉判定に使用されるSEED
      let eyeballSeeds = [];
      for (let i = 0; i < 10; i++) {
          eyeballSeeds.push(i);
      }
      
      // 確定枠がある場合、その位置のSEEDをスキップ
      if (guaranteedRoll !== -1) {
          eyeballSeeds.splice(guaranteedRoll - 1, 1);
      }

      // 10連ガチャのロール結果を格納
      let tenPullResults = [];
      let currentEyeballSeedIndex = 0;
      
      for (let i = 0; i < 10; i++) {
          if (i + 1 === guaranteedRoll) {
              tenPullResults.push({ type: 'guaranteed', roll: i + 1 });
          } else {
              const seedIndex = eyeballSeeds[currentEyeballSeedIndex];
              const isHit = (moduloArray[seedIndex] < gacha.targetRate);
              tenPullResults.push({ type: isHit ? 'eyeball' : 'normal', roll: i + 1, seed: seedIndex + 1 });
              currentEyeballSeedIndex++;
          }
      }
      
      tenPullResults.forEach(result => {
          if (result.type === 'guaranteed') {
              tenPullHtml += `<p>roll${result.roll}: <span style="color:red; font-weight:bold;">目玉(確定)</span></p>`;
          } else if (result.type === 'eyeball') {
              tenPullHtml += `<p>roll${result.roll}: <span style="color:red; font-weight:bold;">目玉</span> (SEED${result.seed})</p>`;
          } else {
              tenPullHtml += `<p>roll${result.roll}: ハズレ (SEED${result.seed})</p>`;
          }
      });
      
      // ハズレ枠の計算と表示
      let normalRolls = tenPullResults.filter(r => r.type === 'normal');
      let currentSeedOffset = 0;

      if (normalRolls.length > 0) {
          tenPullHtml += '<hr><h3>ハズレ枠の算定</h3>';
          
          let lastUsedSeedIndex = eyeballSeeds[eyeballSeeds.length - 1];
          currentSeedOffset = lastUsedSeedIndex + 1;

          for (let i = 0; i < normalRolls.length; i++) {
              const raritySeedIndex = currentSeedOffset;
              const itemSeedIndex = currentSeedOffset + 1;

              if (itemSeedIndex >= xorshiftArray.length) {
                  tenPullHtml += `<p>ロール ${normalRolls[i].roll}: SEEDが不足しています。</p>`;
                  break;
              }

              let rarityId;
              if (moduloArray[raritySeedIndex] < thresholds['0']) { rarityId = 0; }
              else if (moduloArray[raritySeedIndex] < thresholds['1']) { rarityId = 1; }
              else if (moduloArray[raritySeedIndex] < thresholds['2']) { rarityId = 2; }
              else if (moduloArray[raritySeedIndex] < thresholds['3']) { rarityId = 3; }
              else { rarityId = 4; }

              const itemInfo = master[rarityId];
              let itemName = "---";
              if (itemInfo.itemCounts > 0) {
                  const itemOffset = xorshiftArray[itemSeedIndex] % itemInfo.itemCounts;
                  itemName = itemNameMaster[itemInfo.itemNo[itemOffset]] || "不明";
              }

              tenPullHtml += `<p>ロール ${normalRolls[i].roll}: レアリティ(${rarityId}) -> ${itemName} (SEED${raritySeedIndex+1}, ${itemSeedIndex+1})</p>`;

              // 再抽選の判定
              let seedConsumed = 2; // レアリティとアイテムで2つ消費
              if (rarityId === 1 && itemInfo.itemCounts >= 2) {
                  const reGachaSeedIndex = itemSeedIndex + 1;
                  if (reGachaSeedIndex < xorshiftArray.length) {
                      const originalItemNoList = [...itemInfo.itemNo];
                      const itemIndex = originalItemNoList.indexOf(itemInfo.itemNo[xorshiftArray[itemSeedIndex] % itemInfo.itemCounts]);
                      if (itemIndex > -1) {
                          originalItemNoList.splice(itemIndex, 1);
                      }
                      const newDivisor = originalItemNoList.length;
                      const seedForReGacha = xorshiftArray[reGachaSeedIndex];
                      const reGachaOffset = seedForReGacha % newDivisor;
                      const reGachaItemId = originalItemNoList[reGachaOffset];
                      const reGachaItemName = itemNameMaster[reGachaItemId];
                      tenPullHtml += `<p style="margin-left: 20px;">└ 再抽選: ${reGachaItemName} (SEED${reGachaSeedIndex+1})</p>`;
                      seedConsumed = 3; // 再抽選でSEEDを1つ追加消費
                  }
              }
              currentSeedOffset += seedConsumed;
          }
      }

      tenPullResult.innerHTML = tenPullHtml;
    }
    
    function createAndDisplayTable(items, path, isEyeballCell, guaranteedEyeballIndices, moduloArray, gacha) {
        let table = '<table><thead><tr><th class="row-number-header">❐</th><th>A</th><th>B</th><th>C</th></tr></thead><tbody>';
        
        const pathSet = new Set(path);
        const guaranteedEyeballSet = new Set(guaranteedEyeballIndices);

        for (let r = 0; r < 100; r++) {
            table += `<tr><td>${r + 1}</td>`;
            for (let c = 0; c < 3; c++) {
                const index = r * 3 + c;
                let classList = ['re-gacha-cell'];
                
                if (pathSet.has(index)) {
                    classList.push('path-cell');
                    if (isEyeballCell[index]) {
                        classList.push('eyeball-cell');
                    }
                }
                
                if (guaranteedEyeballSet.has(index)) {
                    classList.push('guaranteed-eyeball-cell');
                }
                
                const cellContent = items[index];
                table += `<td class="${classList.join(' ')}">${cellContent}</td>`;
            }

            table += '</tr>';
        }
        
        table += '</tbody></table>';
        resultTableContainer.innerHTML = table;

        const rowNumberHeader = document.querySelector('.row-row-number-header');
        if (rowNumberHeader) {
            rowNumberHeader.addEventListener('click', () => {
                forceReGachaMode = !forceReGachaMode;
                runSimulationAndDisplay();
            });
        }
    }

    runSimulationAndDisplay();
  </script>
</body>
</html>
